<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.10.0/mapbox-gl.css" rel="stylesheet" />
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>

<body>
    <div id="map"></div>
    <script>
        let styles = {
            'basic': 'mapbox://styles/joegermuska/cka9sxxuk1td11in6nbg3jvon',
            'frank': 'mapbox://styles/joegermuska/cka9tuolk0n921jse7dggjtll'
        }

        let PLACES = {
            'chicago': '16000US1714000',
            'wilmette': '16000US1782075',
            'winnetka': '16000US1782530',
            'kenilworth': '16000US1739519',
            'evanston': '16000US1724582',
            'glenview': '16000US1729938',
            'skokie': '16000US1770122',
            'lincolnwood': '16000US1743744',
            'northfield': '16000US1753663',
            'morton-grove': '16000US1750647',
        }


        let PALETTE = //['#a6cee3', '#1f78b4', '#b2df8a', '#33a02c', '#fb9a99', '#e31a1c', '#fdbf6f', '#ff7f00', '#cab2d6', '#6a3d9a']
            ['#8dd3c7', '#ffffb3', '#bebada', '#fb8072', '#80b1d3', '#fdb462', '#b3de69', '#fccde5', '#d9d9d9', '#bc80bd']

        mapboxgl.accessToken = 'pk.eyJ1Ijoiam9lZ2VybXVza2EiLCJhIjoiY2thOXNwNHpwMGp2NDJybnplZHE2NWsxZiJ9.R08AIHjCQZKow3hRRao5MA';
        var map = new mapboxgl.Map({
            container: 'map', // container id
            style: 'mapbox://styles/joegermuska/cka9tuolk0n921jse7dggjtll', // stylesheet location
            // style: styles.frank,
            center: [-87.72294673185576, 42.05386137897145], // starting position [lng, lat]
            zoom: 13 // starting zoom
        });
        map.on('style.load', () => {
            var layers = map.getStyle().layers;
            // Find the index of the first symbol layer in the map style
            var firstSymbolId;
            for (var i = 0; i < layers.length; i++) {
                if (layers[i].type === 'symbol') {
                    firstSymbolId = layers[i].id;
                    break;
                }
            }
            map.addSource('routes', {
                type: 'geojson',
                data: './paths.geojson' // url
            })
            map.addLayer({
                    'id': 'routes-layer',
                    'type': 'line',
                    'source': 'routes',
                    'layout': {},
                    'paint': {
                        'line-color': [
                            'match', ['get', 'type'],
                            'Cycling', 'red', // '#bd4220',
                            '#5520b0'
                        ],
                        'line-width': 2,
                        'line-opacity': .7
                    }
                    // This is the important part of this example: the addLayer
                    // method takes 2 arguments: the layer as an object, and a string
                    // representing another layer's name. if the other layer
                    // exists in the stylesheet already, the new layer will be positioned
                    // right before that layer in the stack, making it possible to put
                    // 'overlays' anywhere in the layer stack.
                    // Insert the layer beneath the first symbol layer.
                },
                firstSymbolId
            );

            map.addSource('saved-places', {
                type: 'geojson',
                data: './lfl.geojson'
            })

            // layer style reference https://docs.mapbox.com/mapbox-gl-js/style-spec/layers/    
            // expressions: https://docs.mapbox.com/mapbox-gl-js/style-spec/expressions/
            map.addLayer({
                id: 'saved-places-show',
                type: 'symbol',
                source: 'saved-places',
                layout: {
                    // get the icon name from the source's "icon" property
                    'icon-image': ['get', 'icon'],
                    // 'icon-color': '#5520b0', seems to break everything
                    'text-field': ['get', 'name'],
                    'text-font': ['DIN Pro Medium', 'Arial Unicode MS Bold'],
                    // 'text-color': '#7e6958', seems to break also?
                    'text-size': 11,
                    'text-offset': [0, 0.6],
                    'text-anchor': 'top'
                },

                paint: {}
            })

            function checkHash() {
                if (location.hash[0] == '#') {
                    let active_places = location.hash.substr(1).split(',')
                    if (active_places.indexOf('all') == 0) {
                        active_places = Object.keys(PLACES)
                    }
                    Object.keys(PLACES).forEach((place, i) => {

                        if (map.getLayer(`${place}-fill`)) {
                            map.removeLayer(`${place}-fill`)
                        }
                        if (map.getLayer(`${place}-line`)) {
                            map.removeLayer(`${place}-line`)
                        }
                        if (active_places.indexOf(place) != -1) {
                            map.addLayer({
                                id: `${place}-fill`,
                                type: 'fill',
                                source: 'places',
                                filter: ["==", ["get", "geoid"],
                                    PLACES[place]
                                ],
                                paint: { // todo.. change colors? add borders?
                                    'fill-color': PALETTE[i],
                                    'fill-opacity': 0.2
                                }
                            }, 'routes-layer')
                            map.addLayer({
                                id: `${place}-line`,
                                type: 'line',
                                source: 'places',
                                filter: ["==", ["get", "geoid"],
                                    PLACES[place]
                                ],
                                paint: { // todo.. change colors? add borders?
                                    'line-color': '#333',
                                    'line-opacity': 1,
                                    'line-width': 1
                                }
                            }, 'routes-layer')
                        }
                    })
                } else {
                    if (map.getLayer('evanston-show')) {
                        map.removeLayer('evanston-show')
                    }
                }

            }
            let places_url = `https://api.censusreporter.org/1.0/geo/show/tiger2018?geo_ids=${Object.values(PLACES).join(',')}`
            map.addSource('places', {
                type: 'geojson',
                data: places_url
            })

            // from https://docs.mapbox.com/mapbox-gl-js/example/polygon-popup-on-click/
            map.on('click', 'routes-layer', function(e) {
                new mapboxgl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML(e.features[0].properties.name)
                    .addTo(map);
            });

            // Change the cursor to a pointer when the mouse is over the routes layer.
            map.on('mouseenter', 'routes-layer', function() {
                map.getCanvas().style.cursor = 'pointer';
            });

            // Change it back to a pointer when it leaves.
            map.on('mouseleave', 'routes-layer', function() {
                map.getCanvas().style.cursor = '';
            });



            map.addControl(new mapboxgl.GeolocateControl({
                trackUserLocation: true
            }))

            checkHash()

            window.addEventListener('hashchange', checkHash)
        })
    </script>

</body>

</html>